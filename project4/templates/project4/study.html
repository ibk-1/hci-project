{% extends "project4/base.html" %}
{% block title %}Study · HCAI Project 4{% endblock %}
{% block content %}
<div class="row g-3">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title mb-1 d-flex align-items-center justify-content-between">
                    <span>Rate this movie</span>
                    <span id="progressBadge" class="badge text-bg-secondary">0 / 10</span>
                </h5>
                <p class="small text-secondary mb-3">Score from 0.5 to 5.0. We’ll preview how a low (★1) vs high (★5)
                    answer changes your recommendations.</p>

                <h5 class="card-title mb-1">Rate this movie</h5>
                <p class="small text-secondary mb-3">Score from 0.5 to 5.0. We’ll preview how a low (★1) vs high (★5)
                    answer changes your recommendations.</p>

                <div id="movieCard" class="d-none">
                    <div class="fs-5 fw-semibold" id="m_title"></div>
                    <div class="small text-secondary" id="m_meta"></div>

                    <div class="mt-3">
                        <label class="form-label small">Your rating: <span id="r_val"
                                class="fw-semibold">3.0</span></label>
                        <input id="r_slider" type="range" min="0.5" max="5" step="0.5" value="3.0" class="form-range">
                        <div class="d-flex gap-2">
                            <button id="btn_low" class="btn btn-outline-secondary btn-sm">Preview @1★</button>
                            <button id="btn_high" class="btn btn-outline-secondary btn-sm">Preview @5★</button>
                            <button id="btn_submit" class="btn btn-dark btn-sm">Submit rating</button>
                        </div>
                    </div>
                </div>

                <div id="doneBox" class="d-none">
                    <p class="small text-secondary mb-2">Thanks! You’ve rated enough items. Your current top
                        recommendations:</p>
                    <ul id="summaryList" class="small"></ul>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h6 class="card-title mb-2">Influence preview</h6>
                <p class="small text-secondary">How your answer can change the Top-5.</p>
                <div class="mb-3">
                    <div class="small text-uppercase text-secondary fw-semibold">Before</div>
                    <ol id="beforeList" class="small ps-3"></ol>
                </div>
                <div>
                    <div class="small text-uppercase text-secondary fw-semibold">After</div>
                    <ol id="afterList" class="small ps-3"></ol>
                </div>
                <div class="mt-3">
                    <div class="small text-uppercase text-secondary fw-semibold">Changes</div>
                    <ul id="diffList" class="small list-unstyled mb-0"></ul>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    let current = null;
    let currentInfluence = null; // store {low:{before,after}, high:{before,after}}

    const $ = (id) => document.getElementById(id);
    const show = (el, yes) => el.classList[yes ? 'remove' : 'add']('d-none');

    function renderMovie(m) {
        $('m_title').textContent = m.title;
        $('m_meta').textContent = [m.year || '', m.genres || ''].filter(Boolean).join(' • ');
    }

    function renderList(containerId, items) {
        const ol = $(containerId);
        ol.innerHTML = '';
        items.forEach(x => {
            const li = document.createElement('li');
            li.textContent = x.title;
            ol.appendChild(li);
        });
    }

    async function fetchNext() {
        const res = await fetch("{% url 'project4:api_next' %}", { method: "POST" });
        const data = await res.json();

        // progress (for both 'done' and 'not done' responses if present)
        if (data.progress) {
            setProgress(data.progress.answered, data.progress.total);
        }

        if (data.done) {
            show($('movieCard'), false);
            show($('doneBox'), true);
            await updateSummary();
            // also clear the influence section for clarity
            $('beforeList').innerHTML = '';
            $('afterList').innerHTML = '';
            $('diffList').innerHTML = '';
            return;
        }

        current = data.movie;
        currentInfluence = data.influence;

        renderMovie(current);
        // Default view = low scenario
        renderList('beforeList', currentInfluence.low.before);
        renderList('afterList', currentInfluence.low.after);
        renderDiff(currentInfluence.low.diff);

        show($('movieCard'), true);
        show($('doneBox'), false);
    }


    async function submitRating() {
        if (!current) return;
        const val = parseFloat($('r_slider').value);
        await fetch("{% url 'project4:api_rate' %}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ml_id: current.ml_id, rating: val })
        });
        await fetchNext();
    }

    $('r_slider').addEventListener('input', e => $('r_val').textContent = e.target.value);
    $('btn_submit').onclick = submitRating;
    $('btn_low').onclick = () => {
        if (!currentInfluence) return;
        renderList('beforeList', currentInfluence.low.before);
        renderList('afterList', currentInfluence.low.after);
        renderDiff(currentInfluence.low.diff);
    };

    $('btn_high').onclick = () => {
        if (!currentInfluence) return;
        renderList('beforeList', currentInfluence.high.before);
        renderList('afterList', currentInfluence.high.after);
        renderDiff(currentInfluence.high.diff);
    };


    fetchNext();
    function setProgress(answered, total) {
        const badge = $('progressBadge');
        badge.textContent = `${answered} / ${total}`;
        badge.className = 'badge text-bg-secondary'; // you can theme by thresholds if you want
    }

    function arrowFor(delta, status) {
        if (status === 'new') return '<span class="badge text-bg-success">NEW</span>';
        if (status === 'dropped') return '<span class="badge text-bg-danger">DROPPED</span>';
        if (delta < 0) return `<span class="text-success">↑ ${Math.abs(delta)}</span>`;
        if (delta > 0) return `<span class="text-danger">↓ ${delta}</span>`;
        return `<span class="text-secondary">→ 0</span>`;
    }

    function renderDiff(items) {
        const ul = $('diffList');
        ul.innerHTML = '';
        if (!items || items.length === 0) {
            ul.innerHTML = '<li class="text-secondary">No changes to show.</li>';
            return;
        }
        // Sort for nicer view: NEW first, then MOVED by magnitude, then DROPPED
        const rank = { new: 0, moved: 1, dropped: 2 };
        items.sort((a, b) => {
            const ra = rank[a.status] ?? 3;
            const rb = rank[b.status] ?? 3;
            if (ra !== rb) return ra - rb;
            const da = Math.abs(a.delta ?? 0), db = Math.abs(b.delta ?? 0);
            return db - da;
        });

        items.forEach(it => {
            const arrow = arrowFor(it.delta ?? 0, it.status);
            const from = (it.from === null || it.from === undefined) ? '—' : `#${it.from + 1}`;
            const to = (it.to === null || it.to === undefined) ? '—' : `#${it.to + 1}`;
            const li = document.createElement('li');
            li.className = 'mb-1';
            li.innerHTML = `
      <span class="fw-semibold">${it.title}</span>
      <span class="ms-1">${arrow}</span>
      <span class="text-secondary ms-2">(from ${from} to ${to})</span>
    `;
            ul.appendChild(li);
        });
    }

</script>
{% endblock %}